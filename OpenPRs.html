<html>
	<head>
		<title>Open PR count on GitHub</title>
	</head>
	<body>
		<div id="loading" style="text-align: center; font-size: 200px">
			<p>Loading...</p>
		</div>
		<div id="results" style="text-align: center; font-size: 250px; visibility: hidden">
			<p>
				<span id="count" style="font-size: 500px"></span> PRs<br />
				Age: <span id="averageAge"></span> days
			</p>
		</div>
		<script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
        <script src="credentials.js"></script>
		<script>
			function update() {
				var items = [];
				function getPage(uri) {
					$.getJSON(uri, function(data, textStatus, jqXHR) {
						$("#loading").hide();
						$("#results").css("visibility", "visible");
						// Set the count
						$("#count").text(data.total_count);
						// Get the items
						items = items.concat(data.items);
						// Average the age
						if (items.length != 0) {
							var itemAges = items.map(function(item) { return new Date() - new Date(item.created_at); });
							var averageAge = itemAges.reduce(function(sum, age) { return sum + age }) / itemAges.length;
							$("#averageAge").text(Math.round(averageAge / 1000 / 60 / 60 / 24 * 10) / 10);
						}
						// Get the link to the next page of results
						var nextLinkSuffix = "; rel=\"next\"";
						var nextLinks = jqXHR.getResponseHeader("Link").split(",").filter(function (link) { return link.endsWith(nextLinkSuffix); });
						if (nextLinks.length > 0) {
							var nextLink = nextLinks[0];
							nextLink = nextLink.substring(1, nextLink.length - nextLinkSuffix.length - 1);
							getPage(nextLink);
						} else {
							if (items.length != data.total_count)
								$("#results").text("Couldn't get all PRs");
						}
					});
				}
				getPage("https://api.github.com/search/issues?q=user%3Adiffblue+type%3Apr+is%3Aopen");
			}
			$(function() {
				$.ajaxSetup({
					beforeSend: function (xhr) {
					    xhr.setRequestHeader ("Authorization", "Basic " + btoa(username + ":" + accessCode));
					}
				});
				update();
			});
			setInterval(update, 5 * 60 * 1000);
		</script>
	</body>
</html>
