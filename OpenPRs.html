<!DOCTYPE html>
<html>
  <head>
    <title>Open PR count on GitHub</title>
  </head>
  <body>
    <div style="text-align: center; font-size: 200px" data-bind="visible: uninitialised">
      <p>Loading...</p>
    </div>
    <div style="text-align: center; font-size: 250px" data-bind="visible: !uninitialised()">
      <p style="margin: 0">
        <span data-bind="text: totalCount" style="font-size: 500px"></span> PRs<br />
        Age: <span data-bind="text: averageAge"></span> days
      </p>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.1/knockout-min.js" integrity="sha256-PX9zWVaICUCeklczWaS9DLBb9uGN7pCkCT0Kyz1elRo=" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="credentials.js"></script>
    <script>
      function SearchResults() {
        var self = this;

        self.items = ko.observableArray([]);
        self.totalCount = ko.observable(0);
        self.averageAge = ko.computed(function () {
          if (self.items().length != 0) {
            var itemAges = self.items().map(function (item) { return new Date() - new Date(item.created_at); });
            var averageAgeMs = itemAges.reduce(function (sum, age) { return sum + age }) / itemAges.length;
            return Math.round(averageAgeMs / 1000 / 60 / 60 / 24 * 10) / 10;
          }
        });

        self.errorMessage = ko.observable();
        self.activeRequests = ko.observable(0);
        self.loading = ko.computed(function () { self.activeRequests() == 0; });
        self.uninitialised = ko.computed(function () { return self.items().length == 0; });

        self.update =
          function () {
            var items = [];
            // Function to load a page of results
            function getPage(uri) {
              self.activeRequests(self.activeRequests() + 1);
              $.getJSON(uri, function (data, textStatus, jqXHR) {
                self.totalCount(data.total_count);
                // Get the items
                self.items(self.items().concat(data.items));
                // Get the link to the next page of results
                var nextLinkSuffix = "; rel=\"next\"";
                var nextLinks = jqXHR.getResponseHeader("Link").split(",").filter(function (link) { return link.endsWith(nextLinkSuffix); });
                if (nextLinks.length > 0) {
                  var nextLink = nextLinks[0];
                  nextLink = nextLink.substring(1, nextLink.length - nextLinkSuffix.length - 1);
                  getPage(nextLink);
                } else {
                  if (self.items().length != self.totalCount())
                    self.errorMessage("Couldn't get all the PRs");
                }
              }).always(function () { self.activeRequests(self.activeRequests() - 1); });
            }
            // Load the first page
            getPage("https://api.github.com/search/issues?q=user%3Adiffblue+type%3Apr+is%3Aopen");
          };
      }
      var viewModel = new SearchResults();

      $(function () {
        $.ajaxSetup({
          beforeSend: function (xhr) {
            xhr.setRequestHeader("Authorization", "Basic " + btoa(username + ":" + accessCode));
          }
        });
        viewModel.update();
        ko.applyBindings(viewModel);
      });
      setInterval(viewModel.update, 5 * 60 * 1000);
    </script>
  </body>
</html>
